<!DOCTYPE html>
<html lang="ar" class="light" dir="rtl">
  <head>
    <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>برا السالفة - لعبة </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    <style>
      body {
        font-family: "IBM Plex Sans Arabic", sans-serif;
      }
      .font-thin {
        font-weight: 100;
      }
      .font-extralight {
        font-weight: 200;
      }
      .font-light {
        font-weight: 300;
      }
      .font-normal {
        font-weight: 400;
      }
      .font-medium {
        font-weight: 500;
      }
      .font-semibold {
        font-weight: 600;
      }
      .font-bold {
        font-weight: 700;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 dark:bg-gray-900 min-h-screen text-gray-800 dark:text-gray-200"
  >
    <!-- Navigation Bar -->
    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3">
      <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">
          برا السالفة
        </h1>
        <div class="flex items-center space-x-2 space-x-reverse">
          <button
            id="scoresModalBtn"
            class="px-4 py-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-300 dark:hover:bg-blue-800"
          >
            النقاط
          </button>
          <button
            id="darkModeToggle"
            class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700"
          >
            <svg
              id="darkIcon"
              class="w-6 h-6 hidden dark:block"
              fill="currentColor"
              viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                fill-rule="evenodd"
                clip-rule="evenodd"
              ></path>
            </svg>
            <svg
              id="lightIcon"
              class="w-6 h-6 block dark:hidden"
              fill="currentColor"
              viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
      <!-- Player Setup Screen -->
      <div id="playerSetup" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">إضافة اللاعبين</h2>
        <form id="playerForm" class="mb-4">
          <div class="flex mb-2">
            <input
              type="text"
              id="playerName"
              class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
              placeholder="أدخل اسم اللاعب"
            />
            <button
              type="submit"
              class="mr-2 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
            >
              إضافة
            </button>
          </div>
        </form>

        <h3 class="font-medium mb-2">اللاعبون:</h3>
        <ul id="playerList" class="mb-4 list-disc list-inside"></ul>

        <button
          id="startGameBtn"
          class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:opacity-50 disabled:cursor-not-allowed dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-800"
          disabled
        >
          اختر الفئة
        </button>
      </div>

      <!-- Category Selection Screen -->
      <div id="categorySelection" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 hidden">
        <h2 class="text-xl font-semibold mb-4">اختر فئة</h2>
        <div id="categoriesList" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
          <!-- Categories will be populated here -->
        </div>
        <button
          id="backToPlayersBtn"
          class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 text-sm"
        >
          ← العودة إلى اللاعبين
        </button>
      </div>

      <!-- Player Role Reveal Screen -->
      <div id="roleRevealScreen" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 hidden">
        <h2 class="text-xl font-semibold mb-4">مرر الهاتف</h2>
        <div id="passingInstructions" class="mb-4">
          <p class="mb-2">
            مرر الهاتف إلى
            <span id="currentPlayerReveal" class="font-bold"></span>
          </p>
          <p>اضغط على "أنا جاهز" عندما يكون الهاتف معك.</p>
        </div>

        <button
          id="playerReadyBtn"
          class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center mb-4 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800"
        >
          أنا جاهز
        </button>

        <div
          id="roleInfo"
          class="text-center p-5 mb-4 border border-gray-200 dark:border-gray-700 rounded-lg hidden"
        >
          <p class="text-lg mb-3">
            الفئة هي:
            <span id="categoryDisplay" class="font-bold"></span>
          </p>
          <div id="nonImposterInfo" class="hidden">
            <p class="text-lg mb-3">
              أنت
              <span class="font-bold text-green-600 dark:text-green-400">داخل</span>
              بالسالفة
            </p>
            
            <p class="text-lg">
              الكلمة السرية هي:
              <span id="secretWordReveal" class="font-bold"></span>
            </p>
          </div>
          <div id="imposterInfo" class="hidden">
            <p class="text-lg mb-3">
              أنت
              <span class="font-bold text-red-600 dark:text-red-400">برا</span>
              السالفة
            </p>
            <p>حاول معرفة الكلمة السرية خلال اللعبة.</p>
          </div>
        </div>

        <button
          id="doneViewingBtn"
          class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center hidden dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-800"
        >
          تم
        </button>
      </div>

      <!-- Questions Screen -->
      <div id="questionsScreen" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 hidden">
        <h2 class="text-xl font-semibold mb-4">جولة الأسئلة</h2>
        <div class="text-center p-4 mb-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <p class="text-lg">
            الفئة:
            <span id="questionCategoryDisplay" class="font-bold"></span>
          </p>
          <p class="text-lg mt-2">
             دور <span id="currentPlayerDisplay" class="font-bold"></span>
          </p>
          <p class="mt-2">
            اطرح سؤالاً على
            <span id="targetPlayerDisplay" class="font-bold"></span>
          </p>
        </div>
        <div class="flex justify-between">
          <button
            id="prevQuestionBtn"
            class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 disabled:opacity-50"
          >
            ← السابق
          </button>
          <button
            id="nextQuestionBtn"
            class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 disabled:opacity-50"
          >
            التالي →
          </button>
        </div>
        <div class="mt-4">
          <button
            id="finishQuestionsBtn"
            class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-800"
          >
            إنهاء الأسئلة
          </button>
        </div>
      </div>

      <!-- Individual Voting Screen -->
      <div id="individualVotingScreen" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 hidden">
        <h2 class="text-xl font-semibold mb-4">التصويت للمحتال</h2>
        <div id="votingInstructions" class="mb-4">
          <p class="mb-2">
            مرر الهاتف إلى
            <span id="currentVoterName" class="font-bold"></span>
            للتصويت
          </p>
          <p>اختر من تعتقد أنه المحتال:</p>
        </div>

        <div id="individualVotingOptions" class="space-y-2 mb-4">
          <!-- Voting options will be populated here -->
        </div>

        <button
          id="submitVoteBtn"
          class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center mb-2 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800"
        >
          تأكيد التصويت
        </button>
      </div>

      <!-- Results Screen -->
      <div id="resultsScreen" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 hidden">
        <h2 class="text-xl font-semibold mb-4">نتائج اللعبة</h2>
        <div class="text-center p-5 mb-6 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <p class="text-xl mb-2">
            برا بالسالفة:
            <span id="revealedImposter" class="font-bold text-red-600 dark:text-red-400"></span>
          </p>
          <p class="text-lg">
            الكلمة السرية كانت:
            <span id="revealedWord" class="font-bold"></span>
          </p>
          <div class="mt-4 text-right">
            <h3 class="text-lg font-medium mb-2">التصويتات الصحيحة:</h3>
            <ul id="correctVotersList" class="list-disc list-inside">
              <!-- Correct voters will be listed here -->
            </ul>
          </div>
        </div>
        <div class="flex flex-col space-y-2">
          <button
            id="newCategoryBtn"
            class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800"
          >
            العب مرة أخرى (فئة جديدة)
          </button>
          <button
            id="newGameBtn"
            class="text-white bg-gray-600 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-gray-500 dark:hover:bg-gray-600 dark:focus:ring-gray-800"
          >
            ابدأ لعبة جديدة (لاعبون جدد)
          </button>
        </div>
      </div>
    </div>

    <!-- Scores Modal -->
    <div
      id="scoresModal"
      class="fixed hidden inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center"
    >
      <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow p-6 m-4 max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
            نقاط اللاعبين
          </h3>
          <button id="closeScoresModal" class="text-gray-400 hover:text-gray-900 dark:hover:text-white">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
              <path
                fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </button>
        </div>
        <div class="mt-2">
          <ul id="playerScoresList" class="space-y-2">
            <!-- Player scores will be populated here -->
          </ul>
        </div>
      </div>
    </div>

    <script>
      // Game data
      const gameCategories = [
        {
          name: "حيوانات",
          items: [
            "أسد",
            "فيل",
            "زرافة",
            "حصان",
            "نمر",
            "بطريق",
            "كنغر",
            "دلفين",
            "نسر",
            "دب",
          ],
        },
        {
          name: "دول",
          items: [
            "اليابان",
            "البرازيل",
            "مصر",
            "استراليا",
            "كندا",
            "إيطاليا",
            "الهند",
            "المكسيك",
            "روسيا",
            "السعودية",
          ],
        },
        {
          name: "أطعمة",
          items: [
            "بيتزا",
            "سوشي",
            "شاورما",
            "شوكولاتة",
            "برجر",
            "معكرونة",
            "كبسة",
            "مندي",
            "آيس كريم",
            "سلطة",
          ],
        },
        {
          name: "رياضات",
          items: [
            "كرة القدم",
            "كرة السلة",
            "تنس",
            "سباحة",
            "جولف",
            "كرة الطائرة",
            "كرة القاعدة",
            "كريكيت",
            "ملاكمة",
            "سكيت بورد",
          ],
        },
        {
          name: "مهن",
          items: [
            "طبيب",
            "معلم",
            "مهندس",
            "طباخ",
            "طيار",
            "فنان",
            "رجل إطفاء",
            "صحفي",
            "ممثل",
            "عالم",
          ],
        },
      ];

      // Game state
      let players = [];
      let playerScores = {};
      let currentCategory = null;
      let secretWord = null;
      let imposter = null;
      let currentQuestionIndex = 0;
      let questionPairs = [];
      let currentPlayerRevealIndex = 0;
      let currentVoterIndex = 0;
      let playerVotes = {};
      let correctVoters = [];

      // DOM elements
      const playerSetup = document.getElementById("playerSetup");
      const categorySelection = document.getElementById("categorySelection");
      const roleRevealScreen = document.getElementById("roleRevealScreen");
      const questionsScreen = document.getElementById("questionsScreen");
      const individualVotingScreen = document.getElementById("individualVotingScreen");
      const resultsScreen = document.getElementById("resultsScreen");
      const scoresModal = document.getElementById("scoresModal");

      // Dark mode toggle
      document.getElementById("darkModeToggle").addEventListener("click", function () {
        document.documentElement.classList.toggle("dark");
      });

      // Scores modal toggle
      document.getElementById("scoresModalBtn").addEventListener("click", function () {
        updateScoresDisplay();
        scoresModal.classList.remove("hidden");
      });

      document.getElementById("closeScoresModal").addEventListener("click", function () {
        scoresModal.classList.add("hidden");
      });

      // Initialize the game
      function initGame() {
        // Set up player form submission
        document.getElementById("playerForm").addEventListener("submit", function (e) {
          e.preventDefault();
          const playerNameInput = document.getElementById("playerName");
          const playerName = playerNameInput.value.trim();

          if (playerName && !players.includes(playerName)) {
            players.push(playerName);
            // Initialize player score if not exists
            if (!playerScores[playerName]) {
              playerScores[playerName] = 0;
            }
            updatePlayerList();
            playerNameInput.value = "";

            // Enable start button if we have enough players
            document.getElementById("startGameBtn").disabled = players.length < 3;
          }
        });

        // Set up category selection rendering
        populateCategories();

        // Set up button event listeners
        document.getElementById("startGameBtn").addEventListener("click", showCategorySelection);
        document.getElementById("backToPlayersBtn").addEventListener("click", backToPlayers);
        document.getElementById("playerReadyBtn").addEventListener("click", showPlayerRole);
        document.getElementById("doneViewingBtn").addEventListener("click", nextPlayerReveal);
        document.getElementById("prevQuestionBtn").addEventListener("click", showPreviousQuestion);
        document.getElementById("nextQuestionBtn").addEventListener("click", showNextQuestion);
        document.getElementById("finishQuestionsBtn").addEventListener("click", startIndividualVoting);
        document.getElementById("submitVoteBtn").addEventListener("click", submitIndividualVote);
        document.getElementById("newCategoryBtn").addEventListener("click", showCategorySelection);
        document.getElementById("newGameBtn").addEventListener("click", resetGame);
      }

      function updatePlayerList() {
        const playerList = document.getElementById("playerList");
        playerList.innerHTML = "";
        players.forEach((player) => {
          const li = document.createElement("li");
          li.className = "flex justify-between items-center mb-1";

          const playerName = document.createElement("span");
          playerName.textContent = player;

          const removeBtn = document.createElement("button");
          removeBtn.innerHTML = "&times;";
          removeBtn.className = "text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300";
          removeBtn.addEventListener("click", function () {
            players = players.filter((p) => p !== player);
            updatePlayerList();
            document.getElementById("startGameBtn").disabled = players.length < 3;
          });

          li.appendChild(playerName);
          li.appendChild(removeBtn);
          playerList.appendChild(li);
        });
      }

      function updateScoresDisplay() {
        const playerScoresList = document.getElementById("playerScoresList");
        playerScoresList.innerHTML = "";
        // Sort players by score (highest first)
        const sortedPlayers = Object.keys(playerScores).sort((a, b) => playerScores[b] - playerScores[a]);
        sortedPlayers.forEach((player) => {
          if (players.includes(player)) {
            const li = document.createElement("li");
            li.className = "flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded";
            const playerName = document.createElement("span");
            playerName.textContent = player;
            const score = document.createElement("span");
            score.textContent = playerScores[player] + " نقطة";
            score.className = "font-bold";
            li.appendChild(playerName);
            li.appendChild(score);
            playerScoresList.appendChild(li);
          }
        });
      }

      function populateCategories() {
        const categoriesList = document.getElementById("categoriesList");
        categoriesList.innerHTML = "";
        gameCategories.forEach((category) => {
          const categoryBtn = document.createElement("button");
          categoryBtn.className = "bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 p-4 rounded-lg text-center";
          categoryBtn.textContent = category.name;
          categoryBtn.addEventListener("click", function () {
            selectCategory(category);
          });
          categoriesList.appendChild(categoryBtn);
        });
      }

      function showCategorySelection() {
        playerSetup.classList.add("hidden");
        resultsScreen.classList.add("hidden");
        categorySelection.classList.remove("hidden");
      }

      function backToPlayers() {
        categorySelection.classList.add("hidden");
        playerSetup.classList.remove("hidden");
      }

      function selectCategory(category) {
        currentCategory = category;
        secretWord = category.items[Math.floor(Math.random() * category.items.length)];
        imposter = players[Math.floor(Math.random() * players.length)];

        // Reset voting data
        playerVotes = {};
        correctVoters = [];

        // Start the player reveal process
        currentPlayerRevealIndex = 0;
        startPlayerReveal();

        // Show the role reveal screen
        categorySelection.classList.add("hidden");
        roleRevealScreen.classList.remove("hidden");
      }

      function startPlayerReveal() {
        // Reset the role reveal screen
        document.getElementById("roleInfo").classList.add("hidden");
        document.getElementById("doneViewingBtn").classList.add("hidden");
        document.getElementById("playerReadyBtn").classList.remove("hidden");
        document.getElementById("passingInstructions").classList.remove("hidden");
        document.getElementById("nonImposterInfo").classList.add("hidden");
        document.getElementById("imposterInfo").classList.add("hidden");

        // Display the current player's name
        document.getElementById("currentPlayerReveal").textContent = players[currentPlayerRevealIndex];
        document.getElementById("categoryDisplay").textContent = currentCategory.name;
      }

      function showPlayerRole() {
        // Show the appropriate role information
        document.getElementById("passingInstructions").classList.add("hidden");
        document.getElementById("playerReadyBtn").classList.add("hidden");
        document.getElementById("roleInfo").classList.remove("hidden");
        document.getElementById("doneViewingBtn").classList.remove("hidden");

        const currentPlayer = players[currentPlayerRevealIndex];

        // Show different information based on whether the player is the imposter
        if (currentPlayer === imposter) {
          document.getElementById("imposterInfo").classList.remove("hidden");
          document.getElementById("nonImposterInfo").classList.add("hidden");
        } else {
          document.getElementById("nonImposterInfo").classList.remove("hidden");
          document.getElementById("imposterInfo").classList.add("hidden");
          document.getElementById("secretWordReveal").textContent = secretWord;
        }
      }

      function nextPlayerReveal() {
        currentPlayerRevealIndex++;
        if (currentPlayerRevealIndex < players.length) {
          // There are more players to reveal to
          startPlayerReveal();
        } else {
          // All players have seen their roles, start the question round
          startQuestions();
        }
      }

      function startQuestions() {
        // Generate question pairs
        generateQuestionPairs();
        currentQuestionIndex = 0;
        // Display the category name
        document.getElementById("questionCategoryDisplay").textContent = currentCategory.name;
        // Show the first question pair
        updateQuestionDisplay();
        // Show questions screen
        roleRevealScreen.classList.add("hidden");
        questionsScreen.classList.remove("hidden");
      }

      function generateQuestionPairs() {
  questionPairs = [];
  // Run two rounds to ensure each player asks and answers twice
  for (let round = 0; round < 2; round++) {
    let askers = [...players];
    let targets = [...players];
    // Shuffle both arrays to randomize pairings
    shuffleArray(askers);
    shuffleArray(targets);
    // Ensure no one is paired with themselves
    for (let i = 0; i < askers.length; i++) {
      if (askers[i] === targets[i]) {
        for (let j = 0; j < targets.length; j++) {
          if (i !== j && askers[i] !== targets[j] && askers[j] !== targets[i]) {
            // Swap targets to avoid self-pairing
            [targets[i], targets[j]] = [targets[j], targets[i]];
            break;
          }
        }
      }
      questionPairs.push({ asker: askers[i], target: targets[i] });
    }
  }
}




      function updateQuestionDisplay() {
        if (currentQuestionIndex < 0) {
          currentQuestionIndex = 0;
        } else if (currentQuestionIndex >= questionPairs.length) {
          currentQuestionIndex = questionPairs.length - 1;
        }
        const currentPair = questionPairs[currentQuestionIndex];
        document.getElementById("currentPlayerDisplay").textContent = currentPair.asker;
        document.getElementById("targetPlayerDisplay").textContent = currentPair.target;
      }

      function showPreviousQuestion() {
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          updateQuestionDisplay();
        }
      }

      function showNextQuestion() {
        if (currentQuestionIndex < questionPairs.length - 1) {
          currentQuestionIndex++;
          updateQuestionDisplay();
        }
      }

      function startIndividualVoting() {
        questionsScreen.classList.add("hidden");
        individualVotingScreen.classList.remove("hidden");
        currentVoterIndex = 0;
        // Reset votes
        playerVotes = {};
        updateVotingDisplay();
      }

      function updateVotingDisplay() {
        document.getElementById("currentVoterName").textContent = players[currentVoterIndex];
        // Populate voting options: list all players except the current voter
        const votingOptionsDiv = document.getElementById("individualVotingOptions");
        votingOptionsDiv.innerHTML = "";
        players.forEach(player => {
          if (player !== players[currentVoterIndex]) {
            const optionLabel = document.createElement("label");
            optionLabel.className = "flex items-center space-x-2 dark:text-gray-100";
            const radio = document.createElement("input");
            radio.type = "radio";
            radio.name = "vote";
            radio.value = player;
            optionLabel.appendChild(radio);
            const span = document.createElement("span");
            span.textContent = player;
            optionLabel.appendChild(span);
            votingOptionsDiv.appendChild(optionLabel);
          }
        });
      }

      function submitIndividualVote() {
        const selectedOption = document.querySelector('input[name="vote"]:checked');
        if (!selectedOption) {
          alert("يرجى اختيار لاعب للتصويت له.");
          return;
        }
        const votedPlayer = selectedOption.value;
        playerVotes[players[currentVoterIndex]] = votedPlayer;
        // Move to next voter
        currentVoterIndex++;
        if (currentVoterIndex < players.length) {
          updateVotingDisplay();
        } else {
          // All votes submitted, show results
          showResults();
        }
      }

      // function showResults() {
      //   individualVotingScreen.classList.add("hidden");
      //   resultsScreen.classList.remove("hidden");
      //   // Display revealed imposter and secret word
      //   document.getElementById("revealedImposter").textContent = imposter;
      //   document.getElementById("revealedWord").textContent = secretWord;
      //   // Calculate correct voters (non-imposter players who voted for the actual imposter)
      //   correctVoters = [];
      //   for (const voter in playerVotes) {
      //     if (playerVotes[voter] === imposter) {
      //       correctVoters.push(voter);
      //       if (voter !== imposter) {
      //         playerScores[voter] = (playerScores[voter] || 0) + 1;
      //       }
      //     }
      //   }
      //   const correctVotersList = document.getElementById("correctVotersList");
      //   correctVotersList.innerHTML = "";
      //   if (correctVoters.length > 0) {
      //     correctVoters.forEach(voter => {
      //       const li = document.createElement("li");
      //       li.textContent = voter;
      //       correctVotersList.appendChild(li);
      //     });
      //   } else {
      //     const li = document.createElement("li");
      //     li.textContent = "لا أحد صوت بشكل صحيح.";
      //     correctVotersList.appendChild(li);
      //   }
      // }


      function showResults() {
  individualVotingScreen.classList.add("hidden");
  resultsScreen.classList.remove("hidden");
  // Reveal the imposter's name but not the secret word yet
  document.getElementById("revealedImposter").textContent = imposter;
  // Clear any previously revealed secret word
  document.getElementById("revealedWord").textContent = "";
  
  // Calculate correct voters for non-imposter players (unchanged)
  correctVoters = [];
  for (const voter in playerVotes) {
    if (playerVotes[voter] === imposter) {
      correctVoters.push(voter);
      if (voter !== imposter) {
        playerScores[voter] = (playerScores[voter] || 0) + 1;
      }
    }
  }
  const correctVotersList = document.getElementById("correctVotersList");
  correctVotersList.innerHTML = "";
  if (correctVoters.length > 0) {
    correctVoters.forEach(voter => {
      const li = document.createElement("li");
      li.textContent = voter;
      correctVotersList.appendChild(li);
    });
  } else {
    const li = document.createElement("li");
    li.textContent = "لا أحد صوت بشكل صحيح.";
    correctVotersList.appendChild(li);
  }
  
  // Start the extra imposter step: let him guess the secret word
  showImposterGuessStep();
}

function showImposterGuessStep() {
  const resultsContainer = document.getElementById("resultsScreen");
  // Create (or reuse) a container for the imposter's guess UI
  let imposterGuessContainer = document.getElementById("imposterGuessContainer");
  if (!imposterGuessContainer) {
    imposterGuessContainer = document.createElement("div");
    imposterGuessContainer.id = "imposterGuessContainer";
    imposterGuessContainer.className = "mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg";
    resultsContainer.appendChild(imposterGuessContainer);
  }
  imposterGuessContainer.innerHTML = ""; // clear previous content

  // Heading for the imposter guess step
  const heading = document.createElement("h3");
  heading.className = "text-lg font-semibold mb-2";
  heading.textContent = "المحتال: اختر الإجابة الصحيحة";
  imposterGuessContainer.appendChild(heading);

  // Generate a list of 8 options (ensuring the secretWord is included)
  let options = [];
  // Get all items from the current category except the secret word
  let otherItems = currentCategory.items.filter(item => item !== secretWord);
  shuffleArray(otherItems);
  const numToPick = Math.min(7, otherItems.length);
  options = otherItems.slice(0, numToPick);
  // Add the secret word and shuffle the options array
  options.push(secretWord);
  shuffleArray(options);

  // Create radio buttons for each option
  options.forEach(option => {
    const label = document.createElement("label");
    label.className = "flex items-center space-x-2 dark:text-gray-100";
    const radio = document.createElement("input");
    radio.type = "radio";
    radio.name = "imposterGuess";
    radio.value = option;
    label.appendChild(radio);
    const span = document.createElement("span");
    span.textContent = option;
    label.appendChild(span);
    imposterGuessContainer.appendChild(label);
  });

  // Create the submit button for the imposter's guess
  const submitBtn = document.createElement("button");
  submitBtn.className = "mt-3 w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800";
  submitBtn.textContent = "تأكيد الإجابة";
  imposterGuessContainer.appendChild(submitBtn);

  submitBtn.addEventListener("click", function() {
    const selectedOption = document.querySelector('input[name="imposterGuess"]:checked');
    if (!selectedOption) {
      alert("يرجى اختيار إجابة.");
      return;
    }
    const imposterGuess = selectedOption.value;
    if (imposterGuess === secretWord) {
      // Correct guess: award a point to the imposter
      playerScores[imposter] = (playerScores[imposter] || 0) + 1;
      alert("إجابة صحيحة! تحصل على نقطة.");
    } else {
      alert("إجابة خاطئة.");
    }
    // Reveal the secret word after the guess is submitted
    document.getElementById("revealedWord").textContent = secretWord;
    // Remove the imposter guess UI from the results screen
    imposterGuessContainer.remove();
    // Update the scores display
    updateScoresDisplay();
  });
}



      function resetGame() {
        // Reset game state
        players = [];
        playerScores = {};
        currentCategory = null;
        secretWord = null;
        imposter = null;
        currentQuestionIndex = 0;
        questionPairs = [];
        currentPlayerRevealIndex = 0;
        currentVoterIndex = 0;
        playerVotes = {};
        correctVoters = [];
        // Hide all game screens except player setup
        categorySelection.classList.add("hidden");
        roleRevealScreen.classList.add("hidden");
        questionsScreen.classList.add("hidden");
        individualVotingScreen.classList.add("hidden");
        resultsScreen.classList.add("hidden");
        playerSetup.classList.remove("hidden");
        updatePlayerList();
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      document.addEventListener("DOMContentLoaded", initGame);
    </script>
  </body>
</html>
